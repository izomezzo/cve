<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      template="index2.xhtml">
    <ui:define name="source">
 			
 			<script type="text/javascript">
 			
				function handleMessage(data) 
				{	
					if(data == 'price')
					{					
						updateWidget();
						console.log("stocks: data is price");
					}
					
				}
				
				function handleGrowl(facesmessage) {
					console.log("handleGrowl");
		            facesmessage.severity = 'info';
		            PF('growl').show([facesmessage]);
		        }
				
				function onError(){
					console.log("on error");
				}
				
				function onStart(){
					console.log("on start");
				}
				
				function onComplete(){
					console.log("on complete");
				}
				
				function onSuccess(){
					console.log("on success");
				}
		</script>
		
		<ui:debug hotkey="x" />
		
        <h:form id="form">
            <p:dataGrid id="prices" var="orderBooks" value="#{stocksView.latestPricesResults}" columns="3" rows="12">
					<f:facet name="header">
			        	WST 100
			        </f:facet>
					<p:column>
   					<p:panel header="#{orderBooks.bidOrderId.member.memberId}">
      			<h:panelGrid columns="1">
   				<h:outputText value="#{orderBooks.price}" />
   				<h:outputText value="#{orderBooks.bidOrderId.member.party}" />
   				<h:outputText value="#{orderBooks.lastUpdate}" />
   				<p:commandLink update=":form:buyDetail" oncomplete="PF('buyDialog').show()" title="View Detail">
                    <h:outputText value="Buy"/>
                    <f:setPropertyActionListener value="#{orderBooks}" target="#{stocksView.selectedStock}" />
                </p:commandLink>
                <p:commandLink update=":form:sellDetail" oncomplete="PF('sellDialog').show()" title="View Detail" rendered="#{stocksView.hasPortfolios[orderBooks.bidOrderId.member.memberId].booleanValue()}">
                    <h:outputText value="Sell"/>
                    <f:setPropertyActionListener value="#{orderBooks}" target="#{stocksView.selectedStock}" />
                </p:commandLink>
				</h:panelGrid>
   				</p:panel>
				</p:column>
				</p:dataGrid>
				
				<p:dialog header="Buy Shares" widgetVar="buyDialog" modal="true" showEffect="fade" hideEffect="fade" resizable="false" appendTo="@(body)">
        			<p:outputPanel id="buyDetail" style="text-align:center;">
            			<p:panelGrid  columns="2" columnClasses="label,value" style="margin:auto">
            			<h:outputText value="Member" />
                		<h:outputText value="#{stocksView.selectedStock.bidOrderId.member.memberId}" />
                		<h:outputText value="Party" />
                		<h:outputText value="#{stocksView.selectedStock.bidOrderId.member.party}" />
                		<h:outputText value="Price" />
                		<h:outputText value="#{stocksView.selectedStock.price}" />
                		</p:panelGrid>              		
                		<h:form style="padding-top:10px;">
                			<p:messages id="msgs" />
                			<h:panelGrid columns="3" cellpadding="5" style="margin:auto">
                			<h:outputText value="Amount:" />
                			<p:inputText id="bidAmount" value="#{stocksView.bidAmount}" required="true" label="BuyAmount" style="max-width:50px;">
                			<p:ajax update="msgAmount" event="keyup"/>   
                			</p:inputText>
                			<p:message for="bidAmount" id="msgAmount" display="icon"/>
                			<h:outputText value="Price:" />
                			<p:inputText id="bidPrice" value="#{stocksView.bidPrice}" required="true" label="BuyPrice" style="max-width:50px;">
                			<p:ajax update="msgPrice" event="keyup"/>   
                			</p:inputText>
                			<p:message for="bidPrice" id="msgPrice" display="icon"/>
                			</h:panelGrid>		
            				<p:commandButton process="@this,bidAmount" update="msgs,:form:prices" value="Buy" id="BuyButton" styleClass="ui-priority-primary" style="margin-top:10px;">
            					<f:actionListener binding="#{stocksView.submitBidOrder()}"/>
    						</p:commandButton>      				
        				</h:form> 
        				</p:outputPanel>      			
    			</p:dialog>
    			
    			<p:dialog header="Sell Shares" widgetVar="sellDialog" modal="true" showEffect="fade" hideEffect="fade" resizable="false" appendTo="@(body)">
        			<p:outputPanel id="sellDetail" style="text-align:center;">
            			<p:panelGrid  columns="2" columnClasses="label,value" style="margin:auto">
            			<h:outputText value="Member" />
                		<h:outputText value="#{stocksView.selectedStock.bidOrderId.member.memberId}" />
                		<h:outputText value="Party" />
                		<h:outputText value="#{stocksView.selectedStock.bidOrderId.member.party}" />
                		<h:outputText value="Price" />
                		<h:outputText value="#{stocksView.selectedStock.price}" />
                		</p:panelGrid>              		
                		<h:form style="padding-top:10px;">
                			<p:messages id="msgs" />
                			<h:panelGrid columns="3" cellpadding="5" style="margin:auto">
                			<h:outputText value="Amount:" />
                			<p:inputText id="askAmount" value="#{stocksView.askAmount}" required="true" label="SellAmount" style="max-width:50px;">
                			</p:inputText>
                			<p:ajax update="msgAmount" event="keyup"/>
                			<p:message for="askAmount" id="msgAmount" display="icon"/>
                			<h:outputText value="Price:"/>
                			<p:inputText id="askPrice" value="#{stocksView.askPrice}" required="true" label="SellPrice" style="max-width:50px;">
                			<p:ajax update="msgPrice" event="keyup"/>   
                			</p:inputText>
                			<p:message for="askPrice" id="msgPrice" display="icon"/>
                			</h:panelGrid>		
            				<p:commandButton process="@this,askAmount" update="msgs" value="Sell" id="SellButton" styleClass="ui-priority-primary" style="margin-top:10px;">      				
        						<f:actionListener binding="#{stocksView.submitAskOrder()}"/>
    						</p:commandButton> 
        				</h:form> 
        				</p:outputPanel>      			
    			</p:dialog>
				
				<p:remoteCommand name="updateWidget"
				 autoRun="true"
                 update="prices"
                 onstart="onStart()"
                 oncomplete="onComplete()"
                 onsuccess="onSuccess()"
                 onerror="onError()">
                 	<f:actionListener binding="#{stocksView.findLatestPrices()}"/>
    				<f:actionListener binding="#{stocksView.hasPortfolios()}"/>
    				<f:actionListener binding="#{stocksView.showGrowl()}"/>
                 </p:remoteCommand>
        </h:form>
     
      <p:socket onMessage="handleMessage" channel="/notify" />
      <p:socket onMessage="handleGrowl" channel="/#{stocksView.userId}" autoConnect="true" widgetVar="subscriber"/>
      
      <p:growl id="growl" widgetVar="growl" showDetail="true" sticky="true"/> 
        
    </ui:define>
       

</ui:composition>